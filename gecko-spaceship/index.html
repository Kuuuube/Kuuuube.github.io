<!DOCTYPE html>
<html lang="en">
    <head>
        <title>Gecko Spaceship</title>
        <style>
            :root {
                --low-thrust-color: rgb(151, 151, 255);
                --low-thrust-size: 75%;

                --high-thrust-color: rgb(255, 137, 137);
                --high-thrust-size: 150%;
            }
            body,
            html {
                width: 100%;
                height: 100%;
                margin: 0;
                user-select: none;
                background-color: rgb(51, 51, 51);
                color: rgb(255, 255, 255);
            }
            #ship {
                width:fit-content;
                height: fit-content;
                user-select: none;
                font-family: monospace;
                text-align: center;
                line-height: 1;
                position: absolute;
                color: rgb(255, 255, 255);
                font-size: 12px;
            }
            #ship_body {
                font-weight: 1000;
            }
            .projectile {
                width:fit-content;
                height: fit-content;
                user-select: none;
                font-family: monospace;
                text-align: center;
                line-height: 1;
                position: absolute;
                color: rgb(255, 255, 255);
            }
        </style>
    </head>
    <body></body>
</html>
<script>
    document.body.innerHTML = "<h1>A gecko browser is required to run this webpage</h1>";
    document.caretPositionFromPoint(0, 0);
    document.body.innerHTML = "<span id=\"ship\"><span id=\"ship_body\">‚ñ≥</span><br><span id=\"thrust\">ùç´</span></span>";
    const SHIP = document.getElementById("ship");
    const SHIP_BODY = document.getElementById("ship_body");
    const THRUST = document.getElementById("thrust");

    const MOVEMENT_STEP_SIZE = 5;
    const MOVEMENT_KEYS_OVERRIDE = window.location.search.match(/(?<=(\?)).*/);
    const DEFAULT_MOVEMENT_KEYS = "wasd";
    const MOVEMENT_KEYS = (MOVEMENT_KEYS_OVERRIDE && MOVEMENT_KEYS_OVERRIDE[0].length >= DEFAULT_MOVEMENT_KEYS.length) ? MOVEMENT_KEYS_OVERRIDE[0] : DEFAULT_MOVEMENT_KEYS;

    const PROJECTILE_SPEED = 10;
    const PROJECTILE_HOLD_RATE_OF_FIRE = 250;

    let current_margins = { top: window.innerHeight / 2, bottom: 0, left: window.innerWidth / 2, right: 0 };
    let current_rotation = 0;
    let currently_held = { left: false, right: false, up: false, down: false, shift: false, ctrl: false, space: false };

    function keydown_handler(e) {
        let current_key = e.key.toLowerCase();
        if (MOVEMENT_KEYS.includes(current_key)) {
            e.preventDefault();
        }
        if (e.repeat) { return; }
        if (current_key === MOVEMENT_KEYS[0]) {
            currently_held.up = true;
        }
        if (current_key === MOVEMENT_KEYS[1]) {
            currently_held.left = true;
        }
        if (current_key === MOVEMENT_KEYS[2]) {
            currently_held.down = true;
        }
        if (current_key === MOVEMENT_KEYS[3]) {
            currently_held.right = true;
        }
        if (current_key === "control") {
            currently_held.ctrl = !currently_held.ctrl;
            currently_held.shift = false;
        }
        if (current_key === "shift") {
            currently_held.shift = !currently_held.shift;
            currently_held.ctrl = false;
        }
        if (current_key === " ") {
            currently_held.space = true;
            shoot_projectile();
        }
    }

    function keyup_handler(e) {
        let current_key = e.key.toLowerCase();
        if (MOVEMENT_KEYS.includes(current_key)) {
            e.preventDefault();
        }
        if (current_key === MOVEMENT_KEYS[0]) {
            currently_held.up = false;
        }
        if (current_key === MOVEMENT_KEYS[1]) {
            currently_held.left = false;
        }
        if (current_key === MOVEMENT_KEYS[2]) {
            currently_held.down = false;
        }
        if (current_key === MOVEMENT_KEYS[3]) {
            currently_held.right = false;
        }
        if (current_key === " ") {
            currently_held.space = false;
        }
    }

    function shoot_projectile() {
        if (!currently_held.space) {
            return;
        }

        // current_margins must be cloned and cannot be a reference
        let margins = JSON.parse(JSON.stringify(current_margins));
        let rotation = current_rotation;
        let adjusted_rotation = current_rotation - 90;

        let projectile = document.createElement("span");
        projectile.className = "projectile";
        projectile.innerText = "‚Äî";
        projectile.style.marginLeft = margins.left + "px";
        projectile.style.marginTop = margins.top + "px";
        projectile.style.rotate = adjusted_rotation + "deg";
        document.body.append(projectile);
        projectile_movement(projectile, margins, rotation);

        if (currently_held.space) {
            setTimeout(shoot_projectile, PROJECTILE_HOLD_RATE_OF_FIRE);
        }
    }

    function projectile_movement(projectile, margins, direction) {
        switch (direction) {
            case 0:
                margins.top -= PROJECTILE_SPEED;
                break;
            case 45:
                margins.top -= PROJECTILE_SPEED / 1.41;
                margins.left += PROJECTILE_SPEED / 1.41;
                break;
            case 90:
                margins.left += PROJECTILE_SPEED;
                break;
            case 135:
                margins.left += PROJECTILE_SPEED / 1.41;
                margins.top += PROJECTILE_SPEED / 1.41;
                break;
            case 180:
                margins.top += PROJECTILE_SPEED;
                break;
            case 225:
                margins.top += PROJECTILE_SPEED / 1.41;
                margins.left -= PROJECTILE_SPEED / 1.41;
                break;
            case 270:
                margins.left -= PROJECTILE_SPEED;
                break;
            case 315:
                margins.left -= PROJECTILE_SPEED / 1.41;
                margins.top -= PROJECTILE_SPEED / 1.41;
                break;
            case 360:
                margins.top -= PROJECTILE_SPEED;
                break;
        }
        projectile.style.marginLeft = margins.left + "px";
        projectile.style.marginTop = margins.top + "px";
        if (margins.left < 0 || window.innerWidth < margins.left || margins.top < 0 || window.innerHeight < margins.top) {
            projectile.remove();
            return;
        }
        setTimeout(function() { projectile_movement(projectile, margins, direction); }, 10);
    }

    function set_position() {
        let ship_info = SHIP.getBoundingClientRect();
        let offset_min = 8;
        let offset_max = -4;
        let x_bounds = {min: 0 + offset_min * 2, max: window.innerWidth - ship_info.width + offset_max};
        let y_bounds = {min: 0 + offset_min, max: window.innerHeight - ship_info.height + offset_max}

        let movement_size = MOVEMENT_STEP_SIZE;
        if (currently_held.ctrl) {
            movement_size = MOVEMENT_STEP_SIZE / 2;
        }
        if (currently_held.shift) {
            movement_size = MOVEMENT_STEP_SIZE * 2;
        }

        current_margins.left -= movement_size * currently_held.left;
        current_margins.left += movement_size * currently_held.right;
        current_margins.top -= movement_size * currently_held.up;
        current_margins.top += movement_size * currently_held.down;

        if (current_margins.left < x_bounds.min) { current_margins.left = x_bounds.min; }
        if (current_margins.left > x_bounds.max) { current_margins.left = x_bounds.max; }
        SHIP.style.marginLeft = current_margins.left + "px";

        if (current_margins.top < y_bounds.min) { current_margins.top = y_bounds.min; }
        if (current_margins.top > y_bounds.max) { current_margins.top = y_bounds.max; }
        SHIP.style.marginTop = current_margins.top + "px";
    }

    function set_text() {
        let movement_vectors = 0;
        let divisor = 0;
        if (currently_held.up) { movement_vectors += 0; divisor++; }
        if (currently_held.up && currently_held.left) { movement_vectors += 360; }
        if (currently_held.right) { movement_vectors += 90; divisor++; }
        if (currently_held.down) { movement_vectors += 180; divisor++; }
        if (currently_held.left) { movement_vectors += 270; divisor++; }

        if (currently_held.right && currently_held.left) { movement_vectors -= 90 + 270; divisor -= 2; }
        if (currently_held.up && currently_held.down) { movement_vectors -= 0 + 180; divisor -= 2; }

        if (divisor === 0) {
            THRUST.style.color = "rgba(0,0,0,0)";
            return;
        }

        let angle = movement_vectors / divisor;
        current_rotation = angle;

        if (currently_held.right || currently_held.left || currently_held.up || currently_held.down) {
            if (currently_held.shift) {
                THRUST.style.color = "var(--high-thrust-color)";
                THRUST.style.fontSize = "var(--high-thrust-size)";
            } else if (currently_held.ctrl) {
                THRUST.style.color = "var(--low-thrust-color)";
                THRUST.style.fontSize = "var(--low-thrust-size)";
            } else {
                THRUST.style.color = "inherit";
                THRUST.style.fontSize = "inherit";
            }
            SHIP.style.rotate = angle + "deg";
        }
    }

    function event_loop() {
        set_position();
        set_text();
        setTimeout(event_loop, 10);
    }

    document.addEventListener("keydown", keydown_handler);
    document.addEventListener("keyup", keyup_handler);
    window.addEventListener("resize", set_position);
    setTimeout(event_loop, 0);
</script>
